(function(global){var V5=function(){};_.extend(V5,EventProxy.prototype);V5.ready=function(callback){if(document.readyState==="complete"){callback()}else{var ready=function(){if(document.readyState==="complete"){callback();$(document).unbind("readystatechange",ready)}};$(document).bind("readystatechange",ready)}};V5.mode=window.innerWidth<768?"phone":"tablet";V5.viewport=null;V5.init=function(){V5.ready(function(){V5.viewport=$("#container");V5.setOrientation();window.addEventListener("touchmove",function(e){e.preventDefault()},false);window.addEventListener('popstate',function(event){var params=event.state;if(params){var args=params.split("/");var currentHash=args.shift();console.log("Hash Changed: "+currentHash);if(V5.hashHistory.length){console.log(V5.hashHistory);if(currentHash!==undefined){var topHash=_.map(V5.hashMap,function(val,key){return _.last(val)});if(_.include(topHash,params)){console.log("changed, but no action.")}else{var hashStack=_.compact(_.map(V5.hashMap,function(val,key){return _.include(val,currentHash)?key:null}));console.log(hashStack);V5.hashMap[hashStack[0]].pop();V5.trigger("openView",currentHash,_.indexOf(V5.columns,hashStack[0]));console.log("Forward or back")}}}}},false);if(V5.hashHistory.length===0){var map=V5.hashMap;if(_.size(map)){console.log("Restore from session.");V5.restoreViews()}else{console.log("Init view.");V5.initView()}}})};var body=$("body");V5.setOrientation=function(){var _setOrientation=function(){var orient=Math.abs(window.orientation)===90?'landscape':'portrait';var aspect=orient==='landscape'?'portrait':'landscape';body.removeClass(aspect).addClass(orient)};_setOrientation();window.addEventListener('orientationchange',_setOrientation,false)};V5._pageCache={};V5.columns=["alpha","beta","gamma"];V5.columnModes=["single","double","triple"];V5.bind("openView",function(viewName,effectColumn,args,viewport){if(V5.mode==="phone"){effectColumn=0}args=args||[];viewport=viewport||V5.viewport;V5.displayView(viewName,effectColumn,args,viewport);var hash=[viewName].concat(args).join("/");history.pushState(hash,viewName,"#"+hash)});V5.initView=function(){V5.trigger("openView","index",0)};V5.restoreViews=function(){var map=V5.hashMap;console.log(map);_.each(map,function(viewNames,columnName){var hash=viewNames.pop();var args=hash.split("/");V5.trigger("openView",args.shift(),_.indexOf(V5.columns,columnName),args,V5.viewport)})};V5.getView=function(viewName,enableL10N,callback){var _pageCache=V5._pageCache;var page=V5._pages[viewName];var proxy=new EventProxy();proxy.assign("l10n","view",function(l10n,view){var html=V5.localize(view,l10n);page.resources=l10n;callback($(html))});if(_pageCache[viewName]){proxy.trigger("view",_pageCache[viewName])}else{$.get("pages/"+viewName+".page?_="+new Date().getTime(),function(text){_pageCache[viewName]=text;proxy.trigger("view",_pageCache[viewName])})}if(page.enableL10N){V5.fetchL10N(viewName,function(){proxy.trigger("l10n",V5.L10N[V5.langCode][viewName])})}else{proxy.trigger("l10n",{})}};V5.displayView=function(hash,effectColumn,args,viewport){var columnName=V5.columns[effectColumn];var column=viewport.find("."+columnName);if(column.size()<1){column=$("<div><div class='column_loading'><div class='loading_animation'></div></div></div>");column.addClass(columnName);viewport.append(column)}if(viewport===V5.viewport){if(V5.hashMap[columnName]){V5.hashMap[columnName].push([hash].concat(args).join("/"))}else{V5.hashMap[columnName]=[[hash].concat(args).join("/")]}V5.hashHistory.push([hash].concat(args))}var page=V5._pages[hash];if(page){var previousPage=column.find("section.page.active").removeClass("active");if(previousPage.length){var id=previousPage.attr('id');var previous=V5._pages[id];if(previous&&id!==hash){previous.shrink()}}var loadingNode=column.find(".column_loading").removeClass("hidden");var page=V5._pages[hash];V5.getView(hash,page.enableL10N,function(view){loadingNode.addClass("hidden");if(viewport===V5.viewport){viewport.attr("class",V5.columnModes[_.size(V5.hashMap)-1])}page.columnIndex=_.indexOf(V5.columns,columnName);if(!page.initialized){column.append(view);page.node=view;page.node.addClass("active");page.initialize.apply(page,args);page.initialized=true}else{if(page.parameters.toString()!==args.toString()){page.destroy();page.node.remove();page.initialized=false;V5.getView(hash,page.enableL10N,arguments.callee);return}else{page.node.addClass("active");page.reappear()}}page.parameters=args;page.viewport=viewport})}else{throw hash+" module doesn't be defined.";}};V5.hashHistory=[];V5.hashMap=(function(){var session=getStorage("session");var hashMap=session.get("hashMap");if(!hashMap){hashMap={}}else{session.remove("hashMap")}$(window).bind("unload",function(){session.put("hashMap",V5.hashMap)});return hashMap}());global.V5=V5}(window));(function(global){V5.View=function(node){var View=Backbone.View.extend({el:node,bind:function(name,method){this[name]=method},undelegateEvents:function(){$(this.el).unbind()}});return new View()}}(window));(function(global){var V5=global.V5;V5._templates={};V5.templateMode="normal";var getTemplateNormally=function(name,callback){var template=V5._templates[name];if(template){callback(template)}else{$.get("templates/"+name+".tmpl?_="+new Date().getTime(),function(templ){V5._templates[name]=templ;callback(templ)})}};var getTemplateOptimized=function(name,callback){var template=V5._templates[name];if(template){callback(template)}else{$.get("templates/optimized_combo.tmpl?_="+new Date().getTime(),function(templ){$(templ).find("script").each(function(index,script){var templateNode=$(script);var id=templateNode.attr("id");V5._templates[id]=templateNode.html()});callback(V5._templates[name])})}};V5.getTemplate=function(name,callback){if(V5.templateMode==="normal"){getTemplateNormally(name,callback)}else{getTemplateOptimized(name,callback)}}}(window));(function(global){var V5=global.V5;V5._pages={};V5.registerPage=function(name,module){if(typeof module==="function"){V5._pages[name]=new V5.Page(module())}};var Page=function(module){_.extend(this,EventProxy.prototype);this.initialize=function(){};this.shrink=function(){};this.reappear=function(){};this.destroy=function(){};this.parameters=null;this.enableL10N=false;_.extend(this,module)};Page.prototype.openView=function(hash,blank){var effectColumn;if(blank){effectColumn=this.columnIndex+1}else{effectColumn=this.columnIndex}var args=hash.split("/");var viewName=args.shift();V5.trigger("openView",viewName,effectColumn,args)};Page.prototype.openViewport=function(hash){var args=hash.split("/");var view=args.shift();var viewport=$("<div></div>").addClass("viewport");$(document.body).append(viewport);V5.trigger("openView",view,0,args,viewport)};Page.prototype.closeViewport=function(hash){this.destroy();this.node.remove();delete this.node;this.initialized=false;this.viewport.remove();delete this.viewport};Page.prototype.call=function(moduleId){var module=V5._modules[moduleId];if(module){module.V5ly(this,[])}else{throw moduleId+" Module doesn't exist";}};Page.prototype.postMessage=function(event,data){this.trigger("page:"+event,data);return this};Page.prototype.onMessage=function(event,callback){this.bind("page:"+event,callback);return this};V5.Page=Page}(window));(function(global){var V5=global.V5;V5._modules={};V5.registerModule=function(moduleId,module){V5._modules[moduleId]=module}}(window));(function(global){var V5=global.V5;V5.langCode="en-US";V5.L10N={};V5.fetchL10N=function(viewName,callback){var code=V5.langCode;$.getJSON("languages/"+viewName+"_"+code+".lang?_="+new Date().getTime(),function(data){V5.L10N[code]=V5.L10N[code]||{};_.extend(V5.L10N[code],data);callback(V5.L10N[code])})};V5.localize=function(template,resources){var settings={interpolate:/\{\{(.+?)\}\}/g};var compiled=_.compile(template,settings);return compiled(resources)}}(window));(function(global){var V5=global.V5;V5.postMessage=function(hash,event,data){var page=V5._pages[hash];if(page){page.postMessage(event,data)}}}(window));